	Lenovo Yoga 2 Pro Special Key Handling and Kernel Module


0/ Problematic Yoga Special Keys

Fn F5	Acts the same as F5
Fn F6	Produces unrecognised scan codes, fix below
Fn F7	Produces ACPI Notify VPC2004 80 0x2000, handled in ideapad-laptop
Fn F9	Works entirely in firmware
Break	Same keycode as Pause, partial fix below
Fn sp	Works entirely in firmware
Fn F7	Produces ACPI Notify VPC2004 80 0x0008, handled in ideapad-laptop
Windows	The on-screen button is indistinguishable from the keyboard key


1/ ideapad-laptop kernel module

ideapad-laptop.c is a modified ideapad kernel module that recognizes Yoga 2
Pros and doesn't set up any physical RF kill switches.  You probably have
this module blacklisted, but the code here fixes the problems on the Yoga 2
Pro.

Right now the only thing that this module is known to be useful for on Yoga
2 Pros is to handle two keys (FnF7 and Novo) that only produce ACPI
notifications.  To use this module, you cannot be running in secure mode, as
the driver will not be signed.

To make the module itself you need to download the kernel development
package.  In Fedora, this is done via
  sudo yum install kernel-devel
Then compile the module via
  make

The module depends on the sparse keymap kernel module.  To ensure that this
is available
  sudo modprobe sparse_keymap
Then to load the module itself
  sudo insmod ./ideapad_laptop.ko 

Alternatively, `sudo make install-driver`, puts the driver into the kernel
modules.  Once this is done, remove the blacklist for the module.  

NOTE:  Each time you install a new kernel you have to boot into the new
kernel, then `make` and `sudo make install-driver`, and then reboot again.


2/ Fn F6 and Break

These two keys are badly handled.   To make them produce reasonable key
codes, edit /etc/udev/hwdb.d/90-yoga-keyboard.hwdb to be
keyboard:dmi:bvn*:bvr*:bd*:svnLENOVO*:pn*20266*:pvr*
 KEYBOARD_KEY_bf=f21		# should be touchpad_toggle, but f21 is used for this
 KEYBOARD_KEY_c6=f24		# should be break, but need something < 255
and then `sudo udevadm hwdb --update`.  Both of these can easily be done via
`sudo make install-keys' 

To make X turn F24 into BREAK, requires xmodmap so edit ~/.Xmodmap to be
keycode 202 = Break

Note:  This solution is not ideal, but X can't handle key codes over 256.
using F21 for touchpad_toggle is a general convention, but F24 for break is
not. 

NOTE:  Some X distributions don't look at ~/.Xmodmap.   The XKB extension
could be used, but that seems like quite a bit of overkill.   If anyone gets
that route to work, please tell how you did it.

NOTE:  Each time you install a new kernel you may have to boot into the new
kernel and then `sudo make install-keys` and then reboot again.




3/ Extra information


Results of probing ACPI notifies

I wrote up a kernel module that attached to all the possible ACPI devices
and reported ACPI notifies.  The only ones I found were for VPC2004, which
is the Embedded Controller.  The ideapad laptop module is also for VPC2004
and identifies two bytes (vpc1 and vpc2) in the EC memory as carrying
information for that notify so I also printed these bits

Device  #  (vp2<<8 | vpc1)

VPC2004 80 08	identified as for the Novo button
	Is indeed generated by Novo button presses, but the length
	information in ideapad_laptop does not seem to work
VPC2004	80 40 	identified as for SwitchVideo key
	Is generated when the lid opens while on AC, i.e., when the
	internal screen is turned back on
VPC2004 80 2000	identified as for the AirplaneMode key
	Is indeed for AirplaneMode key




